<?xml version="1.0" encoding="UTF-8"?>
<chapter version="5.0" xml:id="addon-web-report" xml:lang="es"
         xmlns="http://docbook.org/ns/docbook"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:ns5="http://www.w3.org/1998/Math/MathML"
         xmlns:ns4="http://www.w3.org/2000/svg"
         xmlns:ns3="http://www.w3.org/1999/xhtml"
         xmlns:ns="http://docbook.org/ns/docbook">
  <title xml:lang="es">Add-on Web Report</title>

  <para xml:lang="es">El add-on añade soporte para la generación de
  informes con Jasper Reports y genera sobre una entidad informes
  totalmente funcionales que posteriormente pueden ser personalizados.
  Los informes son accesibles desde la web mediante un 
  formulario que se crea para tal efecto.</para>

  <section xml:id="addon-web-report_descripcion">
    <title xml:lang="es">Descripción</title>

    <para xml:lang="es">El add-on añade por un lado el soporte necesario para trabajar
    con Jasper Reports y por otro es capaz de generar informes asociados con una
    cualquier entidad de la aplicación.</para>

    <para xml:lang="es">Un informe de <emphasis
    role="bold">Jasper Reports</emphasis> se basa en un archivo de diseño del
    informe (jrxml) que al procesarse, proporcionándole una fuente de datos, genera
    un fichero de salida en un formato determinado incluyendo en él la
    información disponible en la fuente de datos.</para>

    <para xml:lang="es">El archivo de diseño es un documento XML con un
    formato determinado que se puede editar de manera sencilla y gráfica
    mediante una herramienta como <link
    xlink:href="http://jasperforge.org/projects/ireport">iReport</link>.</para>

    <figure>
      <title xml:lang="es">Editor de informes iReport</title>

      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="images/ireport.png"></imagedata>
        </imageobject>
      </mediaobject>
    </figure>
  </section>

  <section>
    <title xml:lang="es">Instalación</title>

    <para xml:lang="es">Jasper Reports requiere varias librerías y configuraciones para funcionar,
    el add-on incluye las dependencias de la librería en el proyecto modificando el pom.xml
    del mismo e incluye varios ficheros de configuración que se verán a continuación
    con mas detalle.</para>

    <para xml:lang="es">Estas operaciones de configuración las realiza el comando del add-on
    <link linkend="apendice-comandos_addon-web-report_setup">web report setup</link>:</para>

	<programlisting>
	roo-gvNIX> <command>web report setup</command>
	Updated SRC_MAIN_WEBAPP/WEB-INF/spring/webmvc-config.xml
	Created SRC_MAIN_WEBAPP/WEB-INF/spring/jasper-views.xml
	Created SRC_MAIN_WEBAPP/WEB-INF/classes/jasperfonts
	Created SRC_MAIN_WEBAPP/WEB-INF/classes/jasperfonts/FreeSans.ttf
	Created SRC_MAIN_WEBAPP/WEB-INF/classes/jasperfonts/FreeSansBold.ttf
	Created SRC_MAIN_WEBAPP/WEB-INF/classes/jasperfonts/FreeSansBoldOblique.ttf
	Created SRC_MAIN_WEBAPP/WEB-INF/classes/jasperfonts/FreeSansOblique.ttf
	Created SRC_MAIN_WEBAPP/WEB-INF/classes/jasperfonts/gvnix_reportfonts.xml
	Updated ROOT/pom.xml [added dependency org.gvnix:org.gvnix.web.report.roo.addon:1.0.0; 
			added property 'jasperreports.version' = '4.0.1';
			added property 'jasperreportsfonts.version' = '4.0.0';
			added property 'apachepoi.version' = '3.7';
			added dependencies net.sf.jasperreports:jasperreports:${jasperreports.version},
			org.apache.poi:poi:${apachepoi.version},
			net.sf.jasperreports:jasperreports-fonts:${jasperreportsfonts.version}]
	Created SRC_MAIN_WEBAPP/WEB-INF/classes/jasperreports_extension.properties
	</programlisting>

    <para xml:lang="es">Cada uno de los informes se comporta como una vista más de la aplicación y 
    por tanto el add-on habrá incluido en el fichero de configuración de la capa web
    <emphasis role="bold">webmvc-config.xml</emphasis> el componente que para 
    este tipo de peticiones devolverá el nuevo tipo de salida (un informe). Esto se hace
    añadiendo un nuevo <emphasis>bean</emphasis>:</para>

    <programlisting>&lt;bean id="jasperReportsXmlViewResolver"
    		class="org.springframework.web.servlet.view.XmlViewResolver"
    		p:location="/WEB-INF/spring/<emphasis role="bold">jasper-views.xml</emphasis>" p:order="0" /&gt;</programlisting>

    <para xml:lang="es">Este <emphasis>bean</emphasis> referencia al fichero
    <emphasis>jasper-views.xml</emphasis> como fichero de configuración de las
    nuevas vistas, por tanto el add-on habrá creado este archivo en
    <emphasis>src/main/webapp/WEB-INF/spring</emphasis>.</para>

    <para xml:lang="es">Los informes generados pueden contener textos que se deban visualizar con 
    características especiales tales como negrita y cursiva. Para ello, Jasper Reports
    requiere que las fuentes utilizadas para generar el
    informe se encuentren en el classpath de la aplicación. Así pues, el
    add-on se ocupa de copiar en
    <emphasis>src/main/webapp/WEB-INF/classes/jasperfonts</emphasis>
    varios archivos de fuentes
    True Type y su definición para poder hacer uso de ellas en el archivo
    <emphasis>gvnix_reportfonts.xml</emphasis>. En el archivo
    <emphasis>src/main/webapp/WEB-INF/classes/jasperreports_extension.properties</emphasis>
    se indica a Jasper Reports que utilice estas fuentes a la hora de generar el informe.</para>

    <important>
      <para xml:lang="es">Las fuentes instaladas automáticamente proporcionan soporte para la inclusión
      de texto en negrita y cursiva. El desarrollador debe instalar cualquier otro tipo de fuente
      que se utilice en los informes que diseñe. Para ello, basta con
      ampliar las definiciones <emphasis>fontFamily</emphasis> realizadas en el archivo
      <emphasis>gvnix_reportfonts.xml</emphasis> y copiar los archivos de
      fuente en la carpeta <emphasis>jasperfonts</emphasis>. La inclusión de nuevas
      fuentes se puede realizar utilizando una utilidad que ofrece iReport.
      Desde el menú <emphasis>Herramientas &gt; Opciones > Pestaña
      Fonts</emphasis> se accederá a la siguiente pantalla:</para>

      <figure>
        <title xml:lang="es">Herramienta de gestión de fuentes de IReport</title>

        <mediaobject>
          <imageobject>
            <imagedata align="center" fileref="images/iReportFonts.png"></imagedata>
          </imageobject>
        </mediaobject>
      </figure>

      <para>Desde esta pantalla, seleccionando una fuente de la lista de
      fuentes instaladas en iReports y con el botón <emphasis>"Export as
      extension"</emphasis> se creará un archivo JAR que al descomprimirlo
      contiene:</para>

      <itemizedlist>
        <listitem>
          <para xml:lang="es">Directorio fonts</para>

          <itemizedlist>
            <listitem>
              <para xml:lang="es">Archivos de fuentes en formato TTF.</para>
            </listitem>

            <listitem>
              <para xml:lang="es">Archivo
              <emphasis>fontsfamily&lt;IdentificadorAleatorio&gt;.xml</emphasis></para>
            </listitem>
          </itemizedlist>
        </listitem>

        <listitem>
          <para xml:lang="es">Archivo
          <emphasis>jasperreports_extension.properties</emphasis></para>
        </listitem>
      </itemizedlist>

      <para xml:lang="es">Para instalar esta fuente en la aplicación se deben
      copiar los ficheros con extensión TTF a 
      <emphasis>/WEB-INF/classes/jasperfonts</emphasis> y del archivo
      <emphasis>fontsfamily&lt;IdentificadorAleatorio&gt;.xml</emphasis>
      adaptar el elemento &lt;fontFamily/&gt; para copiarlo en el archivo del proyecto
      <emphasis>gvnix_reportfonts.xml</emphasis> (modificando las rutas para
      que apunten a <emphasis>jasperfonts</emphasis>). El archivo <emphasis>
      jasperreports_extension.properties</emphasis> se puede ignorar porque
      ya se encuentra definido en el proyecto en
      <emphasis>/WEB-INF/classes.</emphasis></para>
    </important>

  </section>
  <section>
    <title xml:lang="es">Generación de un informe</title>

    <para xml:lang="es">El add-on realiza la generación automática de informes
    sobre cualquier entidad de la applicación en la que se está utilizando.
    Posteriormente, los informes podrán ser personalizados por parte
    del desarrollador de la aplicación para adecuarlos a los requerimientos
    modificando o bien lo lógica de negocio o bien el estilo visual como se desee.</para>

    <para xml:lang="es">La petición de un informe, al tratarse de una vista más de la
    aplicación, la ha de atender un controlador. No obstante, los informes
    muestran información referente a una entidad del modelo de datos de la
    aplicación, por tanto el controlador debe atender peticiones
    referentes a una determinada entidad. Esto, como se comentó en <link
    linkend="guia-desarrollo_web_definir-controller_a-mano_automatico">CRUDS
    automático</link>, se configura mediante la anotación
    <emphasis>@RooWebScaffold</emphasis> y su atributo
    <emphasis>formBackingObject.</emphasis> Así pues, no se puede definir un
    informe sobre un controlador que no disponga de la anotación
    <emphasis>@RooWebScaffold</emphasis>.</para>

    <para xml:lang="es">La generación de un informe se realiza mediante el comando <link
    linkend="apendice-comandos_addon-web-report_add">web report add</link> o
    incluyendo la anotación @GvNIXReports en la clase del controlador.
    El comando web report add posee tres parámetros:</para>

    <itemizedlist>
      <listitem>
        <para xml:lang="es">controller: referencia a un controlador existente en el proyecto.
        Como se ha comentado anteriormente, este controlador ha de tener la
        anotación <emphasis>@RooWebScaffold</emphasis> y su atributo
        <emphasis>formBackingObject</emphasis> indicará la entidad para la que
        se generará el informe. Es obligatorio y no tiene valor por defecto.</para>
      </listitem>

      <listitem>
        <para xml:lang="es">reportName: indica el nombre que se le quiere dar al informe. Es
        un string sin espacios y su valor será transformado a minúsculas.
        Es obligatorio y no tiene valor por defecto.</para>
      </listitem>

      <listitem>
        <para xml:lang="es">format: Su valor puede ser
        <emphasis>pdf</emphasis> (Portable Document Format),
        <emphasis>xls</emphasis> (Excel), <emphasis>csv</emphasis> (Comma
        Separated Values) y/o <emphasis>html</emphasis> (HyperText Markup
        Language) o varios de ellos separados por comas para permitir la generación del
        mismo informe en varios formatos. El parámetro es opcional y
        su valor por defecto es <emphasis>pdf</emphasis>.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="es">El comando incluirá la anotación <emphasis>@GvNIXReports</emphasis>
    en la clase controladora e incluira como atributo un array de cadenas en la que cada
    elemento define un informe y los formatos en los que se podrá generar dicho informe.
    Así pues, la anotación:</para>

    <programlisting>@GvNIXReports({ "myfirstreport|pdf,xls,csv" })</programlisting>

    <para xml:lang="es">define un informe cuyo nombre es <emphasis>myfirstreport</emphasis>
    y estará disponible en los formatos pdf, xls y csv.</para>

    <para xml:lang="es">Al lanzar el comando <emphasis>web report add</emphasis> o anotar
    la clase del controlador con <emphasis>@GvNIXReports</emphasis> se
    realizan una serie de modificaciones en el proyecto que darán como resultado la 
    posibilidad de generar un informe desde un formulario de la aplicación.
    Las modificaciones que realiza el comando sobre el proyecto son:</para>

    <itemizedlist>
      <listitem>
        <para xml:lang="es">Crea la clase Java <emphasis
        role="bold">CustomJasperReportsMultiFormatView</emphasis>. La nueva clase se
        creará en el subpaquete <emphasis>servlet.view.jasperreports</emphasis>
        dentro del paquete donde se encuentre el controlador.
        Esta clase se instala solo una vez y en sucesivas ejecuciones se
        comprueba si existe. Esta clase tiene como principal cometido
        establecer, de manera dinámica, el nombre del archivo del informe que
        se genera para su descarga.</para>
      </listitem>

      <listitem>
        <para xml:lang="es">En el archivo <emphasis role="bold">jasper-views.xml</emphasis>
        añade la definición de una nueva vista que será el nuevo informe
        añadido a la aplicación. Se define para ello un bean cuyo id es
        <emphasis>&lt;fromBackingObject&gt;_&lt;reportname&gt;</emphasis> y
        <emphasis>CustomJasperReportsMultiFormatView</emphasis> como clase del
        bean. Si <emphasis>formBackingObject</emphasis> de
        <emphasis>@RooWebScaffold</emphasis> tiene como valor
        <emphasis>Entity</emphasis> y el nombre definido para el informe es
        <emphasis>informe</emphasis>:</para>

        <programlisting>&lt;bean id="entity_informe" 
class="org.gvnix.test.web.servlet.view.jasperreports.CustomJasperReportsMultiFormatView"
p:url="/WEB-INF/reports/entity_informe.jrxml"
p:subReportUrls-ref="subReportUrls"
p:subReportDataKeys-ref="subReportDataKeys" /&gt;</programlisting>
      </listitem>

      <listitem>
        <para xml:lang="es">Crea un archivo de diseño de informe (jrxml) con 
        carios campos de la clase Entity (siguiendo el ejemplo anterior).
        El archivo se creará en
        <emphasis role="bold">src/main/webapp/WEB-INF/reports</emphasis> con
        el nombre <emphasis>entity_informe.jrxml</emphasis>. Este
        archivo se referenciará en el <emphasis>bean</emphasis> del fichero
        <emphasis>jasper-views.xml</emphasis> desde el atributo
        <emphasis>p:url</emphasis>.</para>
      </listitem>

      <listitem>
        <para xml:lang="es">Crea un formulario web bajo <emphasis
        role="bold">src/main/webapp/WEB-INF/views/&lt;entity&gt;
        </emphasis>con nombre <emphasis>&lt;reportname&gt;.jspx</emphasis>
        (informe.jspx siguiendo el ejemplo). Y define esta nueva
        vista en el fichero <emphasis role="bold">views.xml</emphasis>
        situado en el mismo directorio. Esta página permitirá solicitar
        la generación del informe y por defecto lo hará incluyendo los 10
        primeros registros de la entidad.</para>
      </listitem>
      
      <listitem>
        <para xml:lang="es">Incluye las etiquetas multidioma que necesita
        visualizar la generación de informes en
        <emphasis>src/main/webapp/WEB-INF/i18n/application.properties</emphasis>
        y un nuevo enlace del menú en <emphasis>src/main/webapp/WEB-INF/views/menu.jspx
        </emphasis> para poder acceder a la página de generación del informe.</para>
      </listitem>

      <listitem>
        <para xml:lang="es">Crea el aspecto Java
        <emphasis>&lt;controller&gt;_Roo_GvNIXReport.aj</emphasis> con
        los métodos que atenderán las peticiones relacionadas con el
        informe añadido. Se añaden dos métodos por informe:</para>

        <itemizedlist>
          <listitem>
            <para xml:lang="es"><emphasis>generate&lt;Reportname&gt;Form(..)</emphasis>:
            devuelve la vista del formulario web que permite al
            usuario seleccionar el formato de salida del informe y solicitar
            su generación mediante un botón.</para>
          </listitem>

          <listitem>
            <para xml:lang="es"><emphasis>generate&lt;Reportname&gt;(..)</emphasis>: atiende
            la petición de generación del informe recopilando los datos
            necesarios que se deben incluir en él. Para ello, por defecto invoca el método
            <emphasis>&lt;formBackingObject&gt;.find&lt;formBackingObject&gt;Entries(0,
            10)</emphasis> por lo que se tomarán los 10 primeros registros de la entidad para
            rellenar el informe.</para>

            <programlisting>@RequestMapping(value = "/reports/informe", params = "form",
		method = RequestMethod.GET)
public String EntityController.generateInformeForm(Model uiModel) {
    String[] reportFormats =  {"pdf"};
    Collection&lt;String&gt; reportFormatsList = Arrays.asList(reportFormats);
    uiModel.addAttribute("report_formats", reportFormatsList);
    return "users/informe";
}

@RequestMapping(value = "/reports/informe", method = RequestMethod.GET)
public String EntityController.generateInforme(
		@RequestParam(value = "format", required = true) String format, Model uiModel) {
    if ( null == format || format.length() &lt;= 0 ) {
            uiModel.addAttribute("error", "message_format_required");
            return "users/informe";
    }
    final String REGEX = "(pdf)";
    Pattern pattern = Pattern.compile(REGEX, Pattern.CASE_INSENSITIVE);
    Matcher matcher = pattern.matcher(format);
    if ( !matcher.matches() ) {
            uiModel.addAttribute("error", "message_format_invalid");
            return "users/informe";
    }
    Collection&lt;Entity&gt; dataSource = Entity.findEntityEntries(0, 10);
    if (dataSource.isEmpty()) {
            uiModel.addAttribute("error", "message_emptyresults_noreportgeneration");
            return "users/informe";
    }
    uiModel.addAttribute("format", format);
    uiModel.addAttribute("title", "INFORME");
    uiModel.addAttribute("informeList", dataSource);
    return "entity_informe";
}</programlisting>
          </listitem>
        </itemizedlist>
      </listitem>
    </itemizedlist>

    <note>
      <para xml:lang="es">El comando web report add puede ejecutarse tantas veces como se
      desee sobre el mismo controador. Si el nombre del informe a añadir ya
      existe previamente, se añadirán los formatos especificados
      a los ya definidos. Si el nombre dado al nuevo informe
      definido no existía, se añadirá su definición en la anotación
      <emphasis>@GvNIXReports</emphasis>.</para>

      <programlisting>@GvNIXReports({ "myfirstreport|pdf,xls,csv", "mysecondreport|pdf" })</programlisting>
	</note>
	
    <note>
      <para xml:lang="es">Los valores de la anotación <emphasis>@GvNIXReports</emphasis>
      <emphasis role="bold">no son sensibles</emphasis> a mayúsculas por tanto si
      manualmente se establecen los valores de la anotación como:</para>

      <programlisting>@GvNIXReports({ "myfirstreport|pdf", "myFirstREPORT|xls,csv" })</programlisting>

      <para xml:lang="es">es equivalente a:</para>

      <programlisting>@GvNIXReports({ "myfirstreport|pdf,xls,csv" })</programlisting>
    </note>
  </section>

  <section>
    <title xml:lang="es">Futuras versiones</title>

    <para xml:lang="es">Incrementar la funcionalidad del informe generado, 
    incluyendo la visualización de las relaciones que pueda tener la entidad sobre
    la que se declara el informe. En la sección de recetas se muestra una forma de
    mostrar las relaciones de una entidad en el informe mediante el 
    <link linkend="recetas-reports">uso de subinformes</link>.</para>
  </section>
</chapter>
